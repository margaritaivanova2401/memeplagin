const vscode = require('vscode');
const cp = require('child_process');
const path = require('path');

function activate(context) {
  let disposable =
      vscode.commands.registerCommand('happy-compiler.run', function() {
        const editor = vscode.window.activeTextEditor;
        if (!editor) {
          vscode.window.showErrorMessage('–û—Ç–∫—Ä–æ–π —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏!');
          return;
        }

        const filePath = editor.document.fileName;

        const panel = vscode.window.createWebviewPanel(
            'happyCompiler', 'Happy Compiler üòä', vscode.ViewColumn.One, {
              enableScripts: true,
              localResourceRoots:
                  [vscode.Uri.joinPath(context.extensionUri, 'media')]
            });

        const happyImg = panel.webview.asWebviewUri(
            vscode.Uri.joinPath(context.extensionUri, 'media', 'happy.png'));
        const sadImg = panel.webview.asWebviewUri(
            vscode.Uri.joinPath(context.extensionUri, 'media', 'sad.png'));

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–ø–∏–ª—è—Ü–∏—é —á–µ—Ä–µ–∑ gcc (–∏–ª–∏ g++)
        cp.exec(
            `gcc "${filePath}" -o "${filePath}.out"`,
            (error, stdout, stderr) => {
              if (error) {
                // –ö–æ–º–ø–∏–ª—è—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å
                panel.webview.html =
                    getWebviewContent(sadImg, 'üò¢ –ö–æ–º–ø–∏–ª—è—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å!');
              } else {
                // –ö–æ–º–ø–∏–ª—è—Ü–∏—è —É—Å–ø–µ—à–Ω–∞
                panel.webview.html =
                    getWebviewContent(happyImg, 'üéâ –ö–æ–º–ø–∏–ª—è—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
              }
            });
      });

  context.subscriptions.push(disposable);
}

function getWebviewContent(imgUri, message) {
  return `
        <!DOCTYPE html>
        <html lang="ru">
        <head>
            <meta charset="UTF-8">
            <title>Happy Compiler</title>
            <style>
                body { text-align: center; font-family: sans-serif; padding: 20px; }
                img { max-width: 300px; margin-top: 20px; }
                h1 { font-size: 2em; }
            </style>
        </head>
        <body>
            <h1>${message}</h1>
            <img src="${imgUri}" />
        </body>
        </html>
    `;
}

function deactivate() {}

module.exports = {
  activate,
  deactivate
};
